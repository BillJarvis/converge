include @abs_top_srcdir@/Makefile.inc

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
conlibdir = ${libdir}/converge-@CONVERGE_VERSION@

BASE_OBJ_FILES = Compiler/CV_Parser.cvb Compiler/Tokenizer.cvb \
	Compiler/IModule_Gen.cvb Compiler/ITree.cvb Compiler/Bytecode_Gen.cvb \
	Compiler/Targets/Thirty_Two_Bit.cvb Compiler/Compiler_Vars.cvb Compiler/CV_Module.cvb \
	Compiler/QQ_Mode.cvb Compiler/ITree_PP.cvb Compiler/ITree_WF.cvb \
	Compiler/CV_Library.cvb Compiler/CV_Exec.cvb Compiler/Eval.cvb \
	Compiler/Mk_Packages.cvb Compiler/Lift.cvb Compiler/Link.cvb Compiler/ITree_Rename.cvb \
	convergec.cvb convergel.cvb convergei.cvb convergep.cvb

TARGET_OBJ_FILES = Compiler/Targets/Sixty_Four_Bit.cvb Compiler/Targets/Available.cvb

OBJ_FILES = ${BASE_OBJ_FILES} ${TARGET_OBJ_FILES}


%.cvb: %.cv
ifdef BOOTSTRAP
	${CONVERGE_VM} ${CONVERGEC} --bootstrap -o $@ $<
else
	${CONVERGE_VM} ${CONVERGEC} -o $@ $<
endif


all: libcompiler.cvl convergec convergei convergel convergep

install: all
	install -d ${bindir}
	install -c -m 555 convergec ${bindir}
	install -c -m 555 convergei ${bindir}
	install -c -m 555 convergel ${bindir}
	install -c -m 555 convergep ${bindir}
	install -d ${conlibdir}/Compiler
	install -d ${conlibdir}/Compiler/Targets
	install -c -m 444 ${BASE_OBJ_FILES} ${BASE_OBJ_FILES:.cvb=.cv} ${conlibdir}/Compiler
	install -c -m 444 ${TARGET_OBJ_FILES} ${TARGET_OBJ_FILES:.cvb=.cv} ${conlibdir}/Compiler/Targets
	install -c -m 444 libcompiler.cvl ${conlibdir}/Compiler


ifdef TARGET
CROSS_OBJS = ${OBJ_FILES:.cvb=.${TARGET}.cvb}

%.${TARGET}.cvb: %.cv
	${CONVERGE_VM} ${CONVERGEC} -T ${TARGET} -o $@ $<

cross: ${CROSS_OBJS} ${CONVERGE_LIB_DIR}/libconverge.${TARGET}.cvl
	${CONVERGE_VM} ${CONVERGEL} -T ${TARGET} -o convergec.${TARGET} convergec.${TARGET}.cvb ${CROSS_OBJS} ${CONVERGE_LIB_DIR}/libconverge.${TARGET}.cvl
	${CONVERGE_VM} ${CONVERGEL} -T ${TARGET} -o convergel.${TARGET} convergel.${TARGET}.cvb ${CROSS_OBJS} ${CONVERGE_LIB_DIR}/libconverge.${TARGET}.cvl

cross-clean:
	rm -f ${CROSS_OBJS} convergec.${TARGET} convergel.${TARGET}
endif


libcompiler.cvl: ${OBJ_FILES}
	${CONVERGE_VM} ${CONVERGEL} -l -o libcompiler.cvl ${OBJ_FILES}

convergec: ${OBJ_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergec convergec.cvb ${OBJ_FILES}

convergei: ${OBJ_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergei convergei.cvb ${OBJ_FILES}

convergel: ${OBJ_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergel convergel.cvb ${OBJ_FILES}

convergep: ${OBJ_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergep convergep.cvb ${OBJ_FILES}

clean:
	rm -f libcompiler.cvl ${OBJ_FILES}

distclean: clean
	rm -f Makefile convergec convergei convergel convergep
