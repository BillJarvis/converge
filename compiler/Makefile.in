prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
conlibdir = ${libdir}/converge-@CONVERGE_VERSION@

BASE_OBJECT_FILES = Compiler/CV_Parser.cvb Compiler/Tokenizer.cvb \
	Compiler/IModule_Gen.cvb Compiler/ITree.cvb Compiler/Bytecode_Gen.cvb \
	Compiler/Targets/Thirty_Two_Bit.cvb Compiler/Compiler_Vars.cvb Compiler/CV_Module.cvb \
	Compiler/QQ_Mode.cvb Compiler/ITree_Format.cvb Compiler/ITree_TC.cvb \
	Compiler/CEI.cvb Compiler/CV_Library.cvb Compiler/CV_Exec.cvb Compiler/Eval.cvb \
	Compiler/Mk_Packages.cvb Compiler/Lift.cvb \
	convergec.cvb convergel.cvb convergei.cvb convergep.cvb

TARGET_OBJECT_FILES = Compiler/Targets/Sixty_Four_Bit.cvb Compiler/Targets/Available.cvb

OBJECT_FILES = ${BASE_OBJECT_FILES} ${TARGET_OBJECT_FILES}


all: libcompiler.cvl convergec convergei convergel convergep

install:
	install -d ${bindir}
	install -c -m 555 convergec ${bindir}
	install -c -m 555 convergei ${bindir}
	install -c -m 555 convergel ${bindir}
	install -c -m 555 convergep ${bindir}
	install -d ${conlibdir}/Compiler
	install -d ${conlibdir}/Compiler/Targets
	install -c -m 444 ${BASE_OBJECT_FILES} ${BASE_OBJECT_FILES:.cvb=.cv} ${conlibdir}/Compiler
	install -c -m 444 ${TARGET_OBJECT_FILES} ${TARGET_OBJECT_FILES:.cvb=.cv} ${conlibdir}/Compiler/Targets


include @abs_top_srcdir@/Makefile.inc

CONVERGEC_FLAGS += --bootstrap


ifdef TARGET
CROSS_OBJECTS = ${OBJECT_FILES:.cvb=.${TARGET}.cvb}

cross: ${CROSS_OBJECTS} ${CONVERGE_LIB_DIR}/libconverge.${TARGET}.cvl
	${CONVERGE_VM} ${CONVERGEL} -T ${TARGET} -o convergec.${TARGET} convergec.${TARGET}.cvb ${CROSS_OBJECTS} ${CONVERGE_LIB_DIR}/libconverge.${TARGET}.cvl
	${CONVERGE_VM} ${CONVERGEL} -T ${TARGET} -o convergel.${TARGET} convergel.${TARGET}.cvb ${CROSS_OBJECTS} ${CONVERGE_LIB_DIR}/libconverge.${TARGET}.cvl

cross-clean:
	rm -f ${CROSS_OBJECTS} convergec.${TARGET} convergel.${TARGET}
endif

libcompiler.cvl: ${OBJECT_FILES}
	${CONVERGE_VM} ${CONVERGEL} -l -o libcompiler.cvl ${OBJECT_FILES}

convergec: ${OBJECT_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -s -o convergec convergec.cvb ${OBJECT_FILES} ${CONVERGE_LIB}

convergei: ${OBJECT_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -s -o convergei convergei.cvb ${OBJECT_FILES} ${CONVERGE_LIB}

convergel: ${OBJECT_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -s -o convergel convergel.cvb ${OBJECT_FILES} ${CONVERGE_LIB}

convergep: ${OBJECT_FILES} ${CONVERGE_LIB}
	${CONVERGE_VM} ${CONVERGEL} -s -o convergep convergep.cvb ${OBJECT_FILES} ${CONVERGE_LIB}

clean:
	rm -f libcompiler.cvl ${OBJECT_FILES}

distclean: clean
	rm -f Makefile convergec convergei convergel convergep
