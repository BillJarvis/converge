all: 
	cd vm && ${MAKE} ${MFLAGS}
ifeq (${shell ls lib/libconverge.cvl}, )
	# if lib/libconverge.cvl doesn't exist, we go into bootstrapping mode.
	cd lib && ${MAKE} ${MFLAGS} minimal
	cd compiler && ${MAKE} ${MFLAGS}
	cd lib && ${MAKE} ${MFLAGS}
	cd compiler && ${MAKE} ${MFLAGS}
else
	cd lib && ${MAKE} ${MFLAGS}
	cd compiler && ${MAKE} ${MFLAGS}
endif
	cd examples && ${MAKE} ${MFLAGS}
	cd manuals && ${MAKE} ${MFLAGS}
	cd tests && ${MAKE} ${MFLAGS}

install: all
	cd vm && ${MAKE} ${MFLAGS} install
	cd lib && ${MAKE} ${MFLAGS} install
	cd compiler && ${MAKE} ${MFLAGS} install
	cd examples && ${MAKE} ${MFLAGS} install
	cd manuals && ${MAKE} ${MFLAGS} install

clean:
	cd bootstrap && ${MAKE} ${MFLAGS} clean
	cd vm && ${MAKE} ${MFLAGS} clean
	cd lib && ${MAKE} ${MFLAGS} clean
	cd compiler && ${MAKE} ${MFLAGS} clean
	cd examples && ${MAKE} ${MFLAGS} clean
	cd manuals && ${MAKE} ${MFLAGS} clean
	cd tests && ${MAKE} ${MFLAGS} clean

ifdef TARGET
cross: all
	cd lib && ${MAKE} ${MFLAGS} cross
	cd compiler && ${MAKE} ${MFLAGS} cross

cross-clean:
	cd lib && ${MAKE} ${MFLAGS} cross-clean
	cd compiler && ${MAKE} ${MFLAGS} cross-clean
endif

distclean:
	cd bootstrap && ${MAKE} ${MFLAGS} distclean
	cd vm && ${MAKE} ${MFLAGS} distclean
	cd lib && ${MAKE} ${MFLAGS} distclean
	cd compiler && ${MAKE} ${MFLAGS} distclean
	cd examples && ${MAKE} ${MFLAGS} distclean
	cd manuals && ${MAKE} ${MFLAGS} distclean
	cd tests && ${MAKE} ${MFLAGS} distclean
	rm -rf autom4te.cache Makefile Makefile.inc configure config.log config.status

release: distclean
	mkdir converge-@CONVERGE_VERSION@
	${MAKE} -f Makefile.bootstrap configure
	find . -type d | grep -v "_darcs" | grep -v "^\.$$" | sed "s/^\..//" | grep -v "^autom4te.cache" | grep -v "converge-@CONVERGE_VERSION@" | xargs -I {} mkdir -p converge-@CONVERGE_VERSION@/{}
	find . \! -type d | grep -v "_darcs" | sed "s/^\..//" | grep -v "^autom4te.cache" | grep -v "config\..*" | grep -v "\.binaries" | grep -v "\.boring" | grep -v "\.cvsignore" | grep -v "\.core$$" | grep -v ".depend$$" | grep -v "converge-@CONVERGE_VERSION@" | xargs -I {} cp -r {} converge-@CONVERGE_VERSION@/{}
	tar cfz converge-@CONVERGE_VERSION@.tar.gz converge-@CONVERGE_VERSION@
	@echo "\nMake sure that this distribution has the correct version and date!\n  @CONVERGE_VERSION@ (@CONVERGE_DATE@)"

include @abs_top_srcdir@/Makefile.inc
