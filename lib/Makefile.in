include @abs_top_srcdir@/Makefile.inc

prefix = @prefix@
exec_prefix = @exec_prefix@
libdir = @libdir@
conlibdir = ${libdir}/converge-@CONVERGE_VERSION@
INSTALL = @INSTALL@

MINIMAL_OBJS = CPK/Earley/Grammar.cvb CPK/Earley/Parser.cvb CPK/Token.cvb CPK/Tokens.cvb \
	CPK/Tree.cvb File.cvb Functional.cvb Maths.cvb Numbers.cvb Parse_Options.cvb \
	Platform/Properties.cvb Strings.cvb Time.cvb

ALL_OBJS = ${MINIMAL_OBJS} \
	CEI.cvb CPK/Traverser.cvb Platform/Env.cvb Platform/Exec.cvb Sort.cvb \
	XML/Nodes.cvb XML/XDM.cvb XML/XHTML.cvb


%.cvb: %.cv
ifdef BOOTSTRAP
	${CONVERGE_VM} ${CONVERGEC} --bootstrap -o $@ $<
else
	${CONVERGE_VM} ${CONVERGEC} -o $@ $<
endif


all: libconverge.cvl

minimal: ${MINIMAL_OBJS}
	${CONVERGE_VM} ${CONVERGEL} -l -o libconverge.cvl ${MINIMAL_OBJS}

install: all
	${INSTALL} -d ${DESTDIR}${conlibdir}
	${INSTALL} -d ${DESTDIR}${conlibdir}/CPK
	${INSTALL} -d ${DESTDIR}${conlibdir}/CPK/Earley
	${INSTALL} -d ${DESTDIR}${conlibdir}/Platform
	${INSTALL} -d ${DESTDIR}${conlibdir}/XML
	echo ${ALL_OBJS:.cvb=.cv} | tr " " "\n" | xargs -n 1 -I{} ${INSTALL} -c -m 444 {} ${DESTDIR}${conlibdir}/{}
	${INSTALL} -c -m 444 libconverge.cvl ${DESTDIR}${conlibdir}


ifdef TARGET
CROSS_OBJS = ${ALL_OBJS:.cvb=.${TARGET}.cvb}

%.${TARGET}.cvb: %.cv
	${CONVERGE_VM} ${CONVERGEC} -T ${TARGET} -o $@ $<

cross: ${CROSS_OBJS}
	${CONVERGE_VM} ${CONVERGEL} -l -T ${TARGET} -o libconverge.${TARGET}.cvl ${CROSS_OBJS}

cross-clean:
	rm -f ${CROSS_OBJS} libconverge.${TARGET}.cvl
endif


libconverge.cvl: ${ALL_OBJS}
	${CONVERGE_VM} ${CONVERGEL} -l -o libconverge.cvl ${ALL_OBJS}

clean:
	rm -f ${ALL_OBJS} libconverge.cvl

distclean: clean
	rm -f Makefile
