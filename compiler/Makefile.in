include @abs_top_srcdir@/Makefile.inc

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
conlibdir = ${libdir}/converge-@CONVERGE_VERSION@
INSTALL = @INSTALL@

COMPILER_OBJS = Compiler/Parser.cvb Compiler/Tokenizer.cvb \
	Compiler/IMod_Gen.cvb Compiler/ITree.cvb Compiler/Code_Gen.cvb \
	Compiler/Targets/Thirty_Two_Bit.cvb Compiler/Core.cvb Compiler/BC_Mod.cvb \
	Compiler/QQ_Mode.cvb Compiler/ITree_PP.cvb Compiler/ITree_WF.cvb \
	Compiler/BC_Lib.cvb Compiler/BC_Exec.cvb Compiler/Eval.cvb \
	Compiler/Lift.cvb Compiler/Link.cvb Compiler/ITree_Rename.cvb Compiler/BC_Pkg.cvb \
	Compiler/Targets/Sixty_Four_Bit.cvb Compiler/Targets/Available.cvb

PKG_OBJS = Compiler.cvb Compiler/Targets.cvb

EXEC_OBJS = convergec.cvb convergel.cvb convergei.cvb convergep.cvb

OBJ_FILES = ${COMPILER_OBJS} ${TARGET_OBJ_FILES} ${PKG_OBJS} ${EXEC_OBJS}


%.cvb: %.cv
	${CONVERGE_VM} ${CONVERGEC} -o $@ $<

%.cvb: %
	${CONVERGE_VM} ${CONVERGEC} -o $@ $<


all: Compiler.cvl convergec convergei convergel convergep

install: all
	${INSTALL} -d ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 convergec ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 convergei ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 convergel ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 convergep ${DESTDIR}${bindir}
ifeq (@PLATFORM@, MinGW)
	${INSTALL} -c -m 555 ../platform/MinGW/convergec.bat ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 ../platform/MinGW/convergei.bat ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 ../platform/MinGW/convergel.bat ${DESTDIR}${bindir}
	${INSTALL} -c -m 555 ../platform/MinGW/convergep.bat ${DESTDIR}${bindir}
endif
	${INSTALL} -d ${DESTDIR}${conlibdir}/Compiler
	${INSTALL} -d ${DESTDIR}${conlibdir}/Compiler/Targets
	${foreach obj,${COMPILER_OBJS:.cvb=.cv},${INSTALL} -c -m 444 ${obj} ${DESTDIR}${conlibdir}/${obj};}
	${foreach obj,${COMPILER_OBJS},${INSTALL} -c -m 444 ${obj} ${DESTDIR}${conlibdir}/${obj};}
	${foreach obj,${PKG_OBJS},${INSTALL} -c -m 444 ${obj} ${DESTDIR}${conlibdir}/${obj};}
	${INSTALL} -c -m 444 Compiler.cvl ${DESTDIR}${conlibdir}


ifdef TARGET
CROSS_OBJS = ${OBJ_FILES:.cvb=.${TARGET}.cvb}

%.${TARGET}.cvb: %.cv
	${CONVERGE_VM} ${CONVERGEC} -T ${TARGET} -o $@ $<

%.${TARGET}.cvb: %
	${CONVERGE_VM} ${CONVERGEC} -T ${TARGET} -o $@ $<

cross: ${CROSS_OBJS} ${CONVERGE_LIB_DIR}/Stdlib.${TARGET}.cvl
	${CONVERGE_VM} ${CONVERGEL} -T ${TARGET} -o convergec.${TARGET} convergec.${TARGET}.cvb ${CROSS_OBJS} ${CONVERGE_LIB_DIR}/Stdlib.${TARGET}.cvl
	${CONVERGE_VM} ${CONVERGEL} -T ${TARGET} -o convergel.${TARGET} convergel.${TARGET}.cvb ${CROSS_OBJS} ${CONVERGE_LIB_DIR}/Stdlib.${TARGET}.cvl

cross-clean:
	rm -f ${CROSS_OBJS} convergec.${TARGET} convergel.${TARGET}
endif


Compiler.cvl: ${OBJ_FILES}
	${CONVERGE_VM} ${CONVERGEL} -l -o Compiler.cvl ${OBJ_FILES}

convergec: ${OBJ_FILES} ${CONVERGE_STDLIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergec convergec.cvb ${OBJ_FILES}

convergei: ${OBJ_FILES} ${CONVERGE_STDLIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergei convergei.cvb ${OBJ_FILES}

convergel: ${OBJ_FILES} ${CONVERGE_STDLIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergel convergel.cvb ${OBJ_FILES}

convergep: ${OBJ_FILES} ${CONVERGE_STDLIB}
	${CONVERGE_VM} ${CONVERGEL} -o convergep convergep.cvb ${OBJ_FILES}

clean:
	rm -f Compiler.cvl ${OBJ_FILES}

distclean: clean
	rm -f Makefile convergec convergei convergel convergep
